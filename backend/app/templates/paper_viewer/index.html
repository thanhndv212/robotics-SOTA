{% extends "paper_viewer/base.html" %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-lg-3 sidebar p-3">
        <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filters</h5>

        <!-- Statistics -->
        <div class="card stat-card mb-3">
            <div class="card-body text-center">
                <h4>{{ total_papers }}</h4>
                <small>Total Papers</small>
            </div>
        </div>

        <!-- Category Filter -->
        <div class="mb-3">
            <label class="form-label fw-bold">Category</label>
            <select id="categoryFilter" class="form-select">
                <option value="all">All Categories</option>
                {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tag Filter -->
        <div class="mb-3">
            <label class="form-label fw-bold">Tag</label>
            <select id="tagFilter" class="form-select">
                <option value="all">All Tags</option>
                {% for tag in tags %}
                <option value="{{ tag }}">{{ tag }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Statistics by Category -->
        <div class="mt-4">
            <h6 class="fw-bold">Papers by Category</h6>
            {% for category, count in stats.items() %}
            <div class="d-flex justify-content-between align-items-center py-1">
                <small>{{ category }}</small>
                <span class="badge bg-secondary">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9">
        <!-- Search Box -->
        <div class="row mb-4">
            <div class="col">
                <div class="input-group input-group-lg search-box">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control"
                           placeholder="Search papers by title, authors, or content...">
                    <button class="btn btn-outline-secondary" id="clearSearch">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Info -->
        <div class="row mb-3">
            <div class="col">
                <div id="resultsInfo" class="text-muted">
                    Ready to search {{ total_papers }} papers...
                </div>
            </div>
            <div class="col-auto">
                <button id="exportBtn" class="btn btn-outline-primary btn-sm" disabled>
                    <i class="fas fa-download me-1"></i>Export Results
                </button>
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer">
            <div class="text-center text-muted py-5">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>Use the search box above to find papers</p>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFilters = {
    query: '',
    category: 'all',
    tag: 'all'
};

// Search functionality
document.getElementById('searchInput').addEventListener('input', debounce(performSearch, 300));
document.getElementById('categoryFilter').addEventListener('change', performSearch);
document.getElementById('tagFilter').addEventListener('change', performSearch);
document.getElementById('clearSearch').addEventListener('click', clearSearch);
document.getElementById('exportBtn').addEventListener('click', exportResults);

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function performSearch() {
    const query = document.getElementById('searchInput').value;
    const category = document.getElementById('categoryFilter').value;
    const tag = document.getElementById('tagFilter').value;

    currentFilters = { query, category, tag };

    if (!query && category === 'all' && tag === 'all') {
        showDefaultState();
        return;
    }

    showLoading();

    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (category !== 'all') params.append('category', category);
    if (tag !== 'all') params.append('tag', tag);

    axios.get(`/api/paper_viewer/search?${params}`)
        .then(response => {
            displayResults(response.data);
        })
        .catch(error => {
            console.error('Search error:', error);
            showError('Search failed. Please try again.');
        });
}

function displayResults(data) {
    hideLoading();

    const container = document.getElementById('resultsContainer');
    const info = document.getElementById('resultsInfo');
    const exportBtn = document.getElementById('exportBtn');

    info.textContent = `Showing ${data.showing} of ${data.total} results`;
    exportBtn.disabled = data.total === 0;

    if (data.results.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>No papers found matching your criteria</p>
            </div>
        `;
        return;
    }

    const resultsHtml = data.results.map(paper => `
        <div class="card paper-card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-9">
                        <h5 class="card-title">
                            ${paper.url ? `<a href="${paper.url}" target="_blank" class="text-decoration-none">${paper.title}</a>` : paper.title}
                        </h5>
                        <p class="text-muted mb-2">
                            <i class="fas fa-users me-1"></i>${paper.authors.join(', ')}
                        </p>
                        <p class="text-muted mb-2">
                            <i class="fas fa-building me-1"></i>${paper.venue}${paper.year ? `, ${paper.year}` : ''}
                        </p>
                        <p class="card-text">${paper.summary}</p>
                        <div class="mb-2">
                            ${paper.tags.map(tag => `<span class="badge bg-light text-dark tag-badge">${tag}</span>`).join(' ')}
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="badge category-badge bg-primary mb-2">${paper.category}</span><br>
                        <a href="/paper_viewer/paper/${paper.id}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>View Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = resultsHtml;
}

function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'block';
}

function showDefaultState() {
    hideLoading();
    document.getElementById('resultsInfo').textContent = `Ready to search {{ total_papers }} papers...`;
    document.getElementById('exportBtn').disabled = true;
    document.getElementById('resultsContainer').innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="fas fa-search fa-3x mb-3"></i>
            <p>Use the search box above to find papers</p>
        </div>
    `;
}

function showError(message) {
    hideLoading();
    document.getElementById('resultsContainer').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `;
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = 'all';
    document.getElementById('tagFilter').value = 'all';
    showDefaultState();
}

function exportResults() {
    const params = new URLSearchParams();
    if (currentFilters.query) params.append('q', currentFilters.query);
    if (currentFilters.category !== 'all') params.append('category', currentFilters.category);
    if (currentFilters.tag !== 'all') params.append('tag', currentFilters.tag);

    window.location.href = `/paper_viewer/export?${params}`;
}
</script>
{% endblock %}